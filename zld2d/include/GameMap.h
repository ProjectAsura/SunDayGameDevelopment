//-----------------------------------------------------------------------------
// File : Map.h
// Desc : Game Map.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <cstdint>
#include <SpriteSystem.h>
#include <asdxTexture.h>
#include <DirectionState.h>
#include <Box.h>


//-----------------------------------------------------------------------------
// Constant Values.
//-----------------------------------------------------------------------------
static const uint8_t kTileCountX        = 17;
static const uint8_t kTileCountY        = 11;
static const uint8_t kTileTotalCount    = kTileCountX * kTileCountY;
static const uint8_t kTileSize          = 64;
static const int     kMarginX           = 96;   // (1280 - kTileSize * kTileCountX) / 2;
static const int     kMarginY           = 8;    // (720 - kTileSize * kTileCountY) / 2;


///////////////////////////////////////////////////////////////////////////////
// GAMEMAP_TEXTURE enum
///////////////////////////////////////////////////////////////////////////////
enum GAMEMAP_TEXTURE
{
    GAMEMAP_TEXTURE_PLANE,      // 平面.
    GAMEMAP_TEXTURE_ROCK,       // 岩.
    GAMEMAP_TEXTURE_TREE,       // 木
};

///////////////////////////////////////////////////////////////////////////
// Tile structure
///////////////////////////////////////////////////////////////////////////
struct Tile
{
    uint8_t     TextureId;      //!< テクスチャ番号.
    bool        Moveable;       //!< 移動可能.
    bool        Brekable;       //!< 破壊可能.
    bool        Transition;     //!< マップ遷移可能.
};


//-----------------------------------------------------------------------------
//      タイルインデックスを計算します.
//-----------------------------------------------------------------------------
inline Vector2i CalcTileIndex(int x, int y)
{
    auto ix = (x - kMarginX) / kTileSize;
    auto iy = (y - kMarginY) / kTileSize;

    if (ix >= (kTileCountX - 1))
    { ix = kTileCountX - 1; }
    else if (ix < 0)
    { ix = 0; }
    
    if (iy >= (kTileCountY - 1))
    { iy = kTileCountY - 1; }
    else if (iy < 0)
    { iy = 0; }

    return Vector2i(ix, iy);
};

//-----------------------------------------------------------------------------
//      タイルIDを計算します.
//-----------------------------------------------------------------------------
inline uint8_t CalcTileId(const Vector2i& index)
{ return uint8_t(index.x) + uint8_t(index.y) * kTileCountX; }


///////////////////////////////////////////////////////////////////////////////
// GameMap class
///////////////////////////////////////////////////////////////////////////////
class GameMap
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    GameMap();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~GameMap();

    //-------------------------------------------------------------------------
    //! @brief      タイルを設定します.
    //-------------------------------------------------------------------------
    void SetTile(uint8_t id, const Tile& tile);

    //-------------------------------------------------------------------------
    //! @brief      タイルを取得します.
    //-------------------------------------------------------------------------
    Tile GetTile(uint8_t id) const;

    //-------------------------------------------------------------------------
    //! @brief      描画します.
    //-------------------------------------------------------------------------
    void Draw(SpriteSystem& sprite);

    //-------------------------------------------------------------------------
    //! @brief      移動可能かどうかチェックします.
    //-------------------------------------------------------------------------
    bool CanMove(const Box& box, DIRECTION_STATE dir);

    //-------------------------------------------------------------------------
    //! @brief      移動可能かどうかチェックします.
    //-------------------------------------------------------------------------
    bool CanMove(int x, int y, int w, int h, DIRECTION_STATE dir);

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    Tile        m_Tile[kTileCountX * kTileCountY] = {};

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};

///////////////////////////////////////////////////////////////////////////////
// GameMapTexture
///////////////////////////////////////////////////////////////////////////////
class GameMapTextureMgr
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      シングルトンインスタンスを取得します.
    //-------------------------------------------------------------------------
    static GameMapTextureMgr& Instance();

    //-------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //-------------------------------------------------------------------------
    bool Init();

    //-------------------------------------------------------------------------
    //! @brief      破棄処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      シェーダリソースビューを取得します.
    //-------------------------------------------------------------------------
    ID3D11ShaderResourceView* GetSRV(uint32_t index) const;

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    static GameMapTextureMgr        s_Instance;
    std::vector<asdx::Texture2D>    m_Textures;

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOHTING */
};

//-----------------------------------------------------------------------------
//! @brief      ゲームマップを取得します.
//-----------------------------------------------------------------------------
inline ID3D11ShaderResourceView* GetGameMap(uint32_t index)
{ return GameMapTextureMgr::Instance().GetSRV(index); }
